diff --git libpkg/fetch.c libpkg/fetch.c
index 035842b7..fd520ed5 100644
--- libpkg/fetch.c
+++ libpkg/fetch.c
@@ -515,7 +515,9 @@ pkg_fetch_file_to_fd(struct pkg_repo *repo, const char *url, int dest,
 
 		url += strlen(URL_SCHEME_PREFIX);
 		pkg_url_scheme = true;
+	}
 
+	if (repo != NULL) {
 		LL_FOREACH(repo->env, kv) {
 			kvtmp = xcalloc(1, sizeof(*kvtmp));
 			kvtmp->key = xstrdup(kv->key);
